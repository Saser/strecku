version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.13.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - tools-{{ checksum "tools.mk" }}
      - run:
          name: "Install all tools used in the build"
          command: make -f tools.mk tools-all
      - save_cache:
          key: tools-{{ checksum "tools.mk" }}
          paths:
            - build/tools/bin
      - run:
          name: "Make sure Protobuf files are formatted and linted"
          command: make lint-prototool
      - run:
          name: "Make sure generated Protobuf files are up to date"
          command: make lint-prototool-generate
      - run:
          name: "Make sure Go files are properly formatted"
          command: make lint-gofumports
      - run:
          name: "Lint Go files"
          command: make lint-golangci-lint
      - run:
          name: "Make sure Protobuf files are properly formatted and linted"
          command: make lint-prototool
      - run:
          name: "Build all Go packages"
          command: make go-build
      - setup_remote_docker
      - run:
          name: "Run Go unit tests"
          command: make go-test
      - run:
          name: "Build images required for integration tests"
          command: make integrationtest-build
      - run:
          name: "Start containers for integration test environment"
          command: make integrationtest-up
      - run:
          name: "Run integration tests"
          command: make integrationtest-run
      - run:
          name: "Make sure all commits in branch passes CI"
          command: scripts/keep-master-green.bash
